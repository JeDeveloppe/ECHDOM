{# member/components/property/_tab_availbilities.html.twig #}



{# Définition des noms de mois et de jours en français #}
{% set monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai','Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'] %}
{% set dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'] %}

{# --- Affichage conditionnel du formulaire et des disponibilités --- #}

{# Cas 1 : Aucune disponibilité enregistrée, le formulaire est affiché en haut #}
{% if property.propertyAvailabilities is empty %}

    <h3 class="fw-bold text-primary mb-4">Enregistrer une nouvelle disponibilité</h3>
    <p class="text-muted">
        Il n'y a aucune disponibilité enregistrée pour le moment.
        Utilisez le formulaire ci-dessous pour ajouter vos premières dates.
    </p>
    
    {% include "member/property/components/_formAddAvailabilities.html.twig" %}

{% else %}

{# Cas 2 : Des disponibilités existent, elles sont affichées en premier #}
    <h3 class="fw-bold text-primary mb-4">Les disponibilités actuelles</h3>
    <p class="text-muted">Les disponibilités sont organisées par mois. Cliquez sur un mois pour voir les jours disponibles.</p>

    <div class="accordion" id="availabilityAccordion">
        {% set currentMonth = '' %}
        {% set slugCount = 0 %}
        
        {% for availability in home.propertyAvailabilities %}
            {% set newMonth = monthNames[availability.startAt|date('n') - 1] ~ ' ' ~ availability.startAt|date('Y') %}
            {% if newMonth != currentMonth %}
                {% if not loop.first %}
                    </ul>
                </div>
                </div>
                {% endif %}
                
                {% set slugCount = slugCount + 1 %}
                {% set accordionId = 'collapse-' ~ slugCount %}
                
                <div class="accordion-item mb-3 rounded-3 shadow-sm">
                    <h2 class="accordion-header" id="heading-{{ slugCount }}">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#{{ accordionId }}" aria-expanded="false" aria-controls="{{ accordionId }}">
                            {{ newMonth|capitalize }}
                        </button>
                    </h2>
                    <div id="{{ accordionId }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ slugCount }}" data-bs-parent="#availabilityAccordion">
                        <ul class="list-group list-group-flush rounded-bottom-3">
            {% endif %}

            <li class="list-group-item d-flex align-items-center justify-content-between py-3">
                <div class="flex-grow-1">
                    {# Affichage du jour de la semaine et du jour du mois #}
                    {% set dayOfWeek = dayNames[availability.startAt|date('w')] %}
                    <span class="d-block fw-semibold">{{ dayOfWeek }} {{ availability.startAt|date('d') }}</span>
                    {# Affichage de la période avec les heures et les dates complètes #}
                    {% set dayOfWeekFromEndAt = dayNames[availability.endAt|date('w')] %}
                    <span class="text-muted small">Période concernée => du {{ dayOfWeek }} ({{ availability.startAt|date('d/m/Y') }}) à {{ availability.startAt|date('H:i') }} au {{dayOfWeekFromEndAt}} ({{ availability.endAt|date('d/m/Y') }}) à {{ availability.endAt|date('H:i') }} </span>
                </div>
                <span class="badge bg-success text-white py-2 px-3 fw-normal">
                    Disponible
                </span>
            </li>
            
            {% set currentMonth = newMonth %}
        {% endfor %}
        </ul>
        </div>
        </div>
    </div>
    
    <hr class="my-5">
    
    {% include "member/components/_formAddAvailabilities.html.twig" %}
  
{% endif %}

{# Importation des fichiers CSS et JS de Flatpickr #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{# Localisation française de Flatpickr #}
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialise Flatpickr sur le champ 'startAt'
        const startAtInput = document.getElementById('{{ availabilityForm.startAt.vars.id }}');
        if (startAtInput) {
            flatpickr(startAtInput, {
                enableTime: false,
                dateFormat: "Y-m-d",
                locale: "fr",
                altInput: true,
                altFormat: "l j F Y", 
                disable: [
                    function(date) {
                        return (date.getDay() === 0 || date.getDay() === 5 || date.getDay() === 6);
                    }
                ],
            });
        }

        // Initialise Flatpickr sur le champ 'endAt'
        const endAtInput = document.getElementById('{{ availabilityForm.endAt.vars.id }}');
        if (endAtInput) {
            flatpickr(endAtInput, {
                enableTime: false,
                dateFormat: "Y-m-d",
                locale: "fr",
                altInput: true,
                altFormat: "l j F Y",
                disable: [
                    function(date) {
                        return (date.getDay() === 0 || date.getDay() === 5 || date.getDay() === 6);
                    }
                ],
            });
        }
    });
</script>
