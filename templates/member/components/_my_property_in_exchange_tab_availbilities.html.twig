{# member/components/_my_property_in_exchange_tab_availbilities.html.twig #}

{% form_theme availabilityForm 'bootstrap_5_layout.html.twig' %}

{# Définition des noms de mois et de jours en français #}
{% set monthNames = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai','Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'] %}
{% set dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'] %}

{# --- Affichage conditionnel du formulaire et des disponibilités --- #}

{# Cas 1 : Aucune disponibilité enregistrée, le formulaire est affiché en haut #}
{% if home.homeAvailabilities is empty %}
    <h3 class="fw-bold text-primary mb-4">Enregistrer une nouvelle disponibilité</h3>
    <p class="text-muted">
        Il n'y a aucune disponibilité enregistrée pour le moment.
        Utilisez le formulaire ci-dessous pour ajouter vos premières dates.
    </p>
    {{ form_start(availabilityForm, {'attr': {'id': 'availability-form'}}) }}
    <div class="row">
        <div class="col-md-6 mb-4">{{ form_row(availabilityForm.startAt) }}</div>
        <div class="col-md-6 mb-4">{{ form_row(availabilityForm.endAt) }}</div>
    </div>
    
    {# Section avec le texte explicatif mis à jour #}
    <div class="mb-4">
        {{ form_label(availabilityForm.weeklyDays) }}
        <div class="card p-3 bg-light mb-3">
            <h6 class="card-title fw-bold text-dark">Fonctionnement des disponibilités</h6>
            <p class="card-text text-muted small">
                En cochant un ou plusieurs jours de la semaine, vous définissez une disponibilité récurrente. La période que vous indiquez ci-dessus servira à déterminer la plage de temps exacte pour ces jours.
                <br>
                <br>
                <span class="fw-semibold">Par exemple :</span> Si vous cochez <span class="fw-semibold">Lundi</span> et que vous définissez une période allant du <span class="fw-semibold">1er </span> au <span class="fw-semibold">25 du mois</span>, votre bien sera marqué comme disponible <span class="fw-semibold">chaque lundi</span> dès {{ app.request.server.get('HOME_AVAILABILITY_START_HOUR') }} jusqu'au lendemain à {{ app.request.server.get('HOME_AVAILABILITY_END_HOUR') }}, sur toute la période choisie.
            </p>
        </div>
        <div class="d-flex flex-wrap justify-content-start">
            {% for dayField in availabilityForm.weeklyDays %}
                <div class="form-check form-check-inline me-3 mb-2">
                    {{ form_widget(dayField) }}
                    {{ form_label(dayField) }}
                </div>
            {% endfor %}
        </div>
    </div>
    {{ form_rest(availabilityForm) }}
    <button type="submit" class="btn btn-primary mt-4">Enregistrer les disponibilités</button>
    {{ form_end(availabilityForm) }}

{% else %}

{# Cas 2 : Des disponibilités existent, elles sont affichées en premier #}
    <h3 class="fw-bold text-primary mb-4">Les disponibilités actuelles</h3>
    <p class="text-muted">Les disponibilités sont organisées par mois. Cliquez sur un mois pour voir les jours disponibles.</p>

    <div class="accordion" id="availabilityAccordion">
        {% set currentMonth = '' %}
        {% set slugCount = 0 %}
        
        {% for availability in home.homeAvailabilities %}
            {% set newMonth = monthNames[availability.startAt|date('n') - 1] ~ ' ' ~ availability.startAt|date('Y') %}
            {% if newMonth != currentMonth %}
                {% if not loop.first %}
                    </ul>
                </div>
                </div>
                {% endif %}
                
                {% set slugCount = slugCount + 1 %}
                {% set accordionId = 'collapse-' ~ slugCount %}
                
                <div class="accordion-item mb-3 rounded-3 shadow-sm">
                    <h2 class="accordion-header" id="heading-{{ slugCount }}">
                        <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#{{ accordionId }}" aria-expanded="false" aria-controls="{{ accordionId }}">
                            {{ newMonth|capitalize }}
                        </button>
                    </h2>
                    <div id="{{ accordionId }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ slugCount }}" data-bs-parent="#availabilityAccordion">
                        <ul class="list-group list-group-flush rounded-bottom-3">
            {% endif %}

            <li class="list-group-item d-flex align-items-center justify-content-between py-3">
                <div class="flex-grow-1">
                    {# Affichage du jour de la semaine et du jour du mois #}
                    {% set dayOfWeek = dayNames[availability.startAt|date('w')] %}
                    <span class="d-block fw-semibold">{{ dayOfWeek }} {{ availability.startAt|date('d') }}</span>
                    {# Affichage de la période avec les heures et les dates complètes #}
                    {% set dayOfWeekFromEndAt = dayNames[availability.endAt|date('w')] %}
                    <span class="text-muted small">Période concernée => du {{ dayOfWeek }} ({{ availability.startAt|date('d/m/Y') }}) à {{ availability.startAt|date('H:i') }} au {{dayOfWeekFromEndAt}} ({{ availability.endAt|date('d/m/Y') }}) à {{ availability.endAt|date('H:i') }} </span>
                </div>
                <span class="badge bg-success text-white py-2 px-3 fw-normal">
                    Disponible
                </span>
            </li>
            
            {% set currentMonth = newMonth %}
        {% endfor %}
        </ul>
        </div>
        </div>
    </div>
    
    <hr class="my-5">
    
    <h3 class="fw-bold text-primary mb-4">Enregistrer de nouvelles disponibilités</h3>
    <p class="text-muted">
        Utilisez le formulaire ci-dessous pour ajouter de nouvelles disponibilités.
    </p>
    {{ form_start(availabilityForm, {'attr': {'id': 'availability-form'}}) }}
    <div class="row">
        <div class="col-md-6 mb-4">{{ form_row(availabilityForm.startAt) }}</div>
        <div class="col-md-6 mb-4">{{ form_row(availabilityForm.endAt) }}</div>
    </div>
    
    {# Section avec le texte explicatif mis à jour #}
    <div class="mb-4">
        {{ form_label(availabilityForm.weeklyDays) }}
        <div class="card p-3 bg-light mb-3">
            <h6 class="card-title fw-bold text-dark">Fonctionnement des disponibilités</h6>
            <p class="card-text text-muted small">
                En cochant un ou plusieurs jours de la semaine, vous définissez une disponibilité récurrente. La période que vous indiquez ci-dessus servira à déterminer la plage de temps exacte pour ces jours.
                <br>
                <br>
                <span class="fw-semibold">Par exemple :</span> Si vous cochez <span class="fw-semibold">Lundi</span> et que vous définissez une période allant du <span class="fw-semibold">1er </span> au <span class="fw-semibold">25 du mois</span>, votre bien sera marqué comme disponible <span class="fw-semibold">chaque lundi</span> dès {{ app.request.server.get('HOME_AVAILABILITY_START_HOUR') }} jusqu'au lendemain à {{ app.request.server.get('HOME_AVAILABILITY_END_HOUR') }}, sur toute la période choisie.
            </p>
        </div>
        <div class="d-flex flex-wrap justify-content-start">
            {% for dayField in availabilityForm.weeklyDays %}
                <div class="form-check form-check-inline me-3 mb-2">
                    {{ form_widget(dayField) }}
                    {{ form_label(dayField) }}
                </div>
            {% endfor %}
        </div>
    </div>
    {{ form_rest(availabilityForm) }}
    <button type="submit" class="btn btn-primary mt-4">Enregistrer les disponibilités</button>
    {{ form_end(availabilityForm) }}
{% endif %}

{# Importation des fichiers CSS et JS de Flatpickr #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
{# Localisation française de Flatpickr #}
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialise Flatpickr sur le champ 'startAt'
        const startAtInput = document.getElementById('{{ availabilityForm.startAt.vars.id }}');
        if (startAtInput) {
            flatpickr(startAtInput, {
                enableTime: false,
                dateFormat: "Y-m-d",
                locale: "fr",
                altInput: true,
                altFormat: "l j F Y", 
                disable: [
                    function(date) {
                        return (date.getDay() === 0 || date.getDay() === 5 || date.getDay() === 6);
                    }
                ],
            });
        }

        // Initialise Flatpickr sur le champ 'endAt'
        const endAtInput = document.getElementById('{{ availabilityForm.endAt.vars.id }}');
        if (endAtInput) {
            flatpickr(endAtInput, {
                enableTime: false,
                dateFormat: "Y-m-d",
                locale: "fr",
                altInput: true,
                altFormat: "l j F Y",
                disable: [
                    function(date) {
                        return (date.getDay() === 0 || date.getDay() === 5 || date.getDay() === 6);
                    }
                ],
            });
        }
    });
</script>
