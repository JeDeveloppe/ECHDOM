{# templates/search/index.html.twig #}

{% extends 'site/base.html.twig' %}

{% block title %}Trouve ton logement idéal - Proximité{% endblock %}

{% block body %}
    <!-- Overlay de chargement -->
    <div class="loader-overlay position-fixed w-100 h-100 d-flex align-items-center justify-content-center bg-light bg-opacity-75 z-index-1000 d-none" id="loader-overlay">
        <div class="text-center p-4 bg-white rounded-4 shadow-lg">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Recherche en cours...</span>
            </div>
            <div class="fw-bold fs-5 text-dark">Recherche en cours...</div>
            <div class="text-secondary mt-1">Merci de patienter, nous sélectionnons les meilleurs logements pour vous.</div>
        </div>
    </div>

    <!-- Conteneur principal -->
    <div class="container my-5">
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="card p-4 rounded-4 shadow-lg border-0">
                    <div class="bg-primary text-white rounded-top p-3 mx-n4 mt-n4">
                        <span class="fw-semibold fs-5">Critères de recherche</span>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <strong class="text-dark">Votre lieu de travail :</strong>
                                <div class="mt-2">
                                    {% for workplace in app.user.workplaces %}
                                        <span class="badge bg-info-subtle text-info-emphasis rounded-pill me-2 mb-1">{{ workplace.address }}</span>
                                    {% else %}
                                        <span class="text-secondary">Aucun lieu renseigné</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <strong class="text-dark">Temps de trajet actuel :</strong>
                                <div class="mt-2">
                                    <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">{{ timeBetweenmMyHomeAndMyWorkplace }} min.</span>
                                </div>
                            </div>
                        </div>

                        {{ form_start(form, {'attr': {'id': 'search-form'}}) }}
                        {{ form_errors(form) }}
                        <div class="row g-4">
                            <div class="col-md-6">
                                <label for="form_duration" class="form-label text-dark">Durée max (min)</label>
                                <div class="d-flex align-items-center mt-2">
                                    {{ form_widget(form.duration, {'attr': {'oninput': 'updateDurationValue(this.value)', 'id': 'form_duration', 'class': 'form-range'}}) }}
                                    <span id="durationValue" class="fw-bold text-primary fs-5 ms-3">{{ form.duration.vars.value }}</span>
                                </div>
                                {{ form_errors(form.duration) }}
                            </div>
                            {% if form.distance is defined %}
                            <div class="col-md-6">
                                <label for="form_distance" class="form-label text-dark">Distance max (km)</label>
                                <div class="d-flex align-items-center mt-2">
                                    {{ form_widget(form.distance, {'attr': {'oninput': 'updateDistanceValue(this.value)', 'id': 'form_distance', 'class': 'form-range'}}) }}
                                    <span id="distanceValue" class="fw-bold text-primary fs-5 ms-3">{{ form.distance.vars.value }}</span>
                                </div>
                                {{ form_errors(form.distance) }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="d-flex justify-content-center mt-4">
                            <button type="submit" id="submitButton" class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm">
                                <i class="fa-solid fa-magnifying-glass me-2"></i> Rechercher
                            </button>
                        </div>
                        {{ form_end(form) }}
                    </div>
                </div>
            </div>
        </div>

        {% if homes|length > 0 %}
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
                {% for home in homes %}
                    <div class="col">
                        <div class="card rounded-4 shadow-lg border-0 overflow-hidden d-flex flex-column h-100">
                            <div class="card-header bg-light border-bottom-0 p-3">
                                <h5 class="mb-0 fw-semibold text-primary">
                                    {% if home.address is defined %}
                                        {{ home.address }}
                                    {% else %}
                                        Adresse inconnue
                                    {% endif %}
                                </h5>
                            </div>
                            <div class="card-body p-4 d-flex flex-column flex-grow-1">
                                {% if home.timeTravelBetweenHomeAndWorkplace is defined and home.timeTravelBetweenHomeAndWorkplace %}
                                    <div class="w-100 text-end mb-2">
                                        <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Temps de trajet : {{ home.timeTravelBetweenHomeAndWorkplace }} min</span>
                                    </div>
                                {% endif %}
                                {% if home.photos is defined and home.photos|length > 0 %}
                                    <div class="w-100 rounded-4 overflow-hidden mb-3">
                                        <img src="{{ home.photos[0] }}" class="img-fluid rounded-4" style="height: 160px; object-fit: cover;" alt="Photo logement">
                                    </div>
                                {% else %}
                                    <div class="w-100 bg-secondary-subtle rounded-4 d-flex align-items-center justify-content-center text-secondary-emphasis fs-1" style="height: 160px;">
                                        <i class="fa-solid fa-house-heart"></i>
                                    </div>
                                {% endif %}
                                <div class="mb-3">
                                    <strong class="text-dark">Équipements :</strong>
                                    <div class="mt-1 d-flex flex-wrap gap-1">
                                        {% if home.equipments is defined and home.equipments|length > 0 %}
                                            {% for equipment in home.equipments %}
                                                {% if equipment.name is defined %}
                                                    <span class="badge bg-info-subtle text-info-emphasis rounded-pill">{{ equipment.name }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-secondary-emphasis fs-6">Aucun équipement</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if home.price is defined and home.price %}
                                    <div class="mb-3">
                                        <span class="badge bg-success-subtle text-success-emphasis rounded-pill">Prix : {{ home.price|number_format(0, ',', ' ') }} €</span>
                                    </div>
                                {% endif %}
                                <button type="button"
                                        class="mt-auto btn btn-primary w-100 rounded-pill shadow-sm"
                                        onclick='showHomeDetails({{ home.address|json_encode|raw }}, {{ home.equipments|json_encode|raw }}, {{ home.price|default(0) }}, {{ home.timeTravelBetweenHomeAndWorkplace|default(0) }});'>
                                    <i class="fa-solid fa-circle-info me-2"></i> Voir plus
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="row justify-content-center mb-4">
                <div class="col-lg-8">
                    <div class="p-4 rounded-4 text-center bg-warning-subtle text-warning-emphasis">
                        <i class="fa-regular fa-face-smile me-2"></i> Aucun lieu disponible pour le moment. Revenez bientôt !
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="row justify-content-center mt-4">
            {% if map is not null %}
                <div class="col-lg-10">
                    <div class="rounded-4 shadow-lg overflow-hidden" style="height: 400px;">
                        {{ ux_map(map, {style: 'height: 100%; width: 100%'}) }}
                    </div>
                </div>
            {% else %}
                <div class="col-lg-8">
                    <div class="p-4 rounded-4 text-center bg-info-subtle text-info-emphasis">
                        <i class="fa-solid fa-map-location-dot me-2"></i> Aucune carte disponible.
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal des détails du logement -->
    <div class="modal fade" id="homeDetailsModal" tabindex="-1" aria-labelledby="homeDetailsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg">
          <div class="modal-header bg-primary text-white rounded-top-4">
            <h5 class="modal-title fw-semibold" id="homeDetailsModalLabel">Détails du logement</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body p-4">
            <h6 class="fw-bold text-dark mb-2">Adresse : <span id="modalAddress" class="fw-normal text-primary"></span></h6>
            <h6 class="fw-bold text-dark mb-2">Prix : <span id="modalPrice" class="fw-normal text-primary"></span></h6>
            <h6 class="fw-bold text-dark mb-3">Temps de trajet : <span id="modalTravelTime" class="fw-normal text-primary"></span></h6>
            <h6 class="fw-bold text-dark mb-2">Équipements :</h6>
            <div id="modalEquipments" class="d-flex flex-wrap gap-1">
              <!-- Les badges des équipements seront injectés ici -->
            </div>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        // Met à jour les valeurs des sliders en temps réel
        function updateDurationValue(val) {
            document.getElementById('durationValue').innerText = val;
        }

        {% if form.distance is defined %}
        function updateDistanceValue(val) {
            document.getElementById('distanceValue').innerText = val;
        }
        {% endif %}

        // Gère l'affichage de l'overlay de chargement
        document.getElementById('search-form').addEventListener('submit', function() {
            document.getElementById('loader-overlay').classList.remove('d-none');
        });

        // Fonction pour afficher les détails dans la modale
        function showHomeDetails(address, equipments, price, travelTime) {
            document.getElementById('modalAddress').innerText = address;
            document.getElementById('modalPrice').innerText = price.toLocaleString('fr-FR') + ' €';
            document.getElementById('modalTravelTime').innerText = travelTime + ' min';

            // Gère l'affichage des équipements
            const equipmentsContainer = document.getElementById('modalEquipments');
            equipmentsContainer.innerHTML = ''; // Nettoie le conteneur
            if (equipments && equipments.length > 0) {
                equipments.forEach(eq => {
                    const span = document.createElement('span');
                    span.className = 'badge bg-info-subtle text-info-emphasis rounded-pill';
                    span.innerText = eq.name;
                    equipmentsContainer.appendChild(span);
                });
            } else {
                const span = document.createElement('span');
                span.className = 'text-secondary-emphasis';
                span.innerText = 'Aucun équipement';
                equipmentsContainer.appendChild(span);
            }

            // Affiche la modale
            var homeDetailsModal = new bootstrap.Modal(document.getElementById('homeDetailsModal'));
            homeDetailsModal.show();
        }
    </script>
{% endblock %}
