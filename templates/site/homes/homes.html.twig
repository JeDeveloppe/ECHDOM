{% extends 'site/base.html.twig' %}

{% block title %}Trouve ton logement idéal - ECHDOM{% endblock %}

{% block stylesheets %}
{% endblock %}

{% block body %}
<div class="loader-overlay" id="loader-overlay">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Recherche en cours...</span>
        </div>
        <div class="fw-bold mb-1">Recherche en cours...</div>
        <div class="text-muted">Merci de patienter, nous sélectionnons les meilleurs logements pour vous.</div>
    </div>
</div>

<div class="container my-4">
    <div class="row justify-content-center mb-4">
        <div class="col-lg-7">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-header bg-primary text-white">
                    <span class="fw-bold">Critères de recherche</span>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Votre lieu de travail :</strong><br>
                            {% for workplace in app.user.workplaces %}
                                <span class="badge bg-info text-dark mb-1">{{ workplace.address }}</span>
                            {% else %}
                                <span class="text-muted">Aucun lieu renseigné</span>
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            <strong>Temps de trajet actuel :</strong>
                            <span class="badge bg-primary bg-opacity-75">{{ timeBetweenmMyHomeAndMyWorkplace }} min.</span>
                        </div>
                    </div>
                    {{ form_start(form) }}
                    {{ form_errors(form) }}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="form_duration" class="form-label">Durée max (min)</label>
                            <div class="d-flex align-items-center gap-2">
                                {{ form_widget(form.duration, {'attr': {'oninput': 'updateDurationValue(this.value)', 'id': 'form_duration'}}) }}
                                <span id="durationValue" class="fw-bold text-primary ms-2">{{ form.duration.vars.value }}</span>
                            </div>
                            {{ form_errors(form.duration) }}
                        </div>
                        {% if form.distance is defined %}
                        <div class="col-md-6 mb-3">
                            <label for="form_distance" class="form-label">Distance max (km)</label>
                            <div class="d-flex align-items-center gap-2">
                                {{ form_widget(form.distance, {'attr': {'oninput': 'updateDistanceValue(this.value)', 'id': 'form_distance'}}) }}
                                <span id="distanceValue" class="fw-bold text-primary ms-2">{{ form.distance.vars.value }}</span>
                            </div>
                            {{ form_errors(form.distance) }}
                        </div>
                        {% endif %}
                    </div>
                    <div class="row">
                        <div class="col text-center">
                            <button type="submit" id="submitButton" class="btn btn-primary rounded-pill px-5">
                                <i class="bi bi-search"></i> Rechercher
                            </button>
                        </div>
                    </div>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>
    </div>

    {% if homes|length > 0 %}
        <div class="row g-4">
            {% for home in homes %}
                <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12 d-flex">
                    <div class="card flex-fill h-100">
                        <div class="card-header">
                            <h5 class="mb-0 text-primary">
                                {% if home.address is defined %}
                                    {{ home.address }}
                                {% else %}
                                    Adresse inconnue
                                {% endif %}
                            </h5>
                        </div>
                        <div class="card-body pb-2">
                            {% if home.timeTravelBetweenHomeAndWorkplace is defined and home.timeTravelBetweenHomeAndWorkplace %}
                                <div class="col-12 text-end mb-2">
                                    <span class="badge bg-success rounded-pill">Temps de trajet : {{ home.timeTravelBetweenHomeAndWorkplace }} min</span>
                                </div>
                            {% endif %}
                            {% if home.photos is defined and home.photos|length > 0 %}
                                <div id="carouselHome{{ loop.index }}" class="carousel slide mb-2" data-bs-ride="carousel">
                                    <div class="carousel-inner">
                                        {% for photo in home.photos %}
                                            <div class="carousel-item {% if loop.first %}active{% endif %}">
                                                <img src="{{ photo }}" class="d-block w-100 rounded" style="max-height:140px;object-fit:cover;" alt="Photo logement">
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if home.photos|length > 1 %}
                                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselHome{{ loop.index }}" data-bs-slide="prev">
                                            <span class="carousel-control-prev-icon"></span>
                                            <span class="visually-hidden">Précédent</span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#carouselHome{{ loop.index }}" data-bs-slide="next">
                                            <span class="carousel-control-next-icon"></span>
                                            <span class="visually-hidden">Suivant</span>
                                        </button>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="img-placeholder">
                                    <i class="bi bi-house-heart"></i>
                                </div>
                            {% endif %}
                            <div class="mb-2">
                                <strong>Équipements :</strong>
                                <div class="equipments-list mt-1">
                                    {% if home.equipments is defined and home.equipments|length > 0 %}
                                        {% for equipment in home.equipments %}
                                            {% if equipment.name is defined %}
                                                <span class="badge bg-info text-dark rounded-pill">{{ equipment.name }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-muted">Aucun équipement</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if home.price is defined and home.price %}
                                <div class="mb-1">
                                    <span class="badge bg-success rounded-pill">Prix : {{ home.price|number_format(0, ',', ' ') }} €</span>
                                </div>
                            {% endif %}
                            <a href="#"
                               class="btn btn-outline-primary rounded-pill mt-2"
                               onclick="showHomeDetails('{{ home.address|e('js') }}', {{ home.equipments|json_encode|raw }}, {{ home.price|default(0) }}, {{ home.timeTravelBetweenHomeAndWorkplace|default(0) }});return false;">
                                <i class="bi bi-info-circle"></i> Voir plus
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="row justify-content-center mb-4">
            <div class="col-lg-6 text-center">
                <div class="alert alert-warning rounded-pill">
                    <i class="bi bi-emoji-smile"></i> Aucun lieu disponible pour le moment. Revenez bientôt !
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row justify-content-center mt-4">
        <div class="col-lg-10">
            {% if map is not null %}
                <div class="rounded-4 shadow-sm overflow-hidden" style="height: 400px;">
                    {{ ux_map(map, {style: 'height: 100%; width: 100%'}) }}
                </div>
            {% else %}
                <div class="alert alert-info text-center rounded-pill">Aucune carte disponible.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Equipements -->
<div class="modal fade" id="equipmentsModal" tabindex="-1" aria-labelledby="equipmentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="equipmentsModalLabel">Équipements du logement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body" id="modalEquipmentsBody">
        <!-- Equipements dynamiques ici -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/homes/homes.js') }}"></script>
{% endblock %}